---
title: "Model building"
output:
  html_document:
    df_print: paged
---

```{r}
library(dplyr)
library(ggplot2)
library(patchwork)
library(MASS)
library(performance)
library(mgcv)
# library(flextable)
# library(cowplot)
# library(ggsci)
```

```{r}
processed_path <- "data/processed/"
centralities_filename <- "centralities.csv"
centralities_filepath <- fs::path(processed_path, centralities_filename)
centralities <- readr::read_csv(centralities_filepath, col_types = "ccccd")
```

# Data wrangling

```{r}
dataset <- centralities %>% 
  mutate(
    incidence = new_cases / population_permanent,
    ubn = hh_1_nbi_or_more / number_hh
  ) %>% 
  dplyr::select(
    -c(
      department:province, ubigeo, idh, life_expectancy:family_income, 
      number_hh:aai, ntl, so2, tmmn, tmmx
    )
  )
```

# Univariate analysis

## Descriptive tables

```{r echo=FALSE}
# statistics <- c(
#   "{min}, {max}", "{median} ({p25}, {p75})", "{mean} ({sd})", "{skewness}", 
#   "{kurtosis}"
# )
# stats_labels <- c("Range", "Median (IQR)", "Mean (SD)", "Skewness", "Kurtosis")
# digits <- rep(2, 9)
```

### Demographics

```{r echo=FALSE}
# dataset %>% 
#   dplyr::select(new_cases:work_rate_intra) %>% 
#   tbl_summary(
#     statistic = all_continuous2() ~ statistics,
#     digits = all_continuous2() ~ digits,
#     type = everything() ~ "continuous2"
#   ) %>% 
#   add_stat_label(label = all_continuous() ~ stats_labels)
```

### Centrality measures

```{r}
centralities_long <- dataset %>% 
  dplyr::select(district, contains("centrality")) %>% 
  tidyr::pivot_longer(
    cols = -district,
    names_to = c("source", "variable", "centrality", "mode"),
    names_sep = "_"
  ) %>% 
  tidyr::pivot_wider(
    id_cols = c(district, source),
    names_from = c(variable, centrality, mode),
    values_from = value
  )
```

```{r echo=FALSE}
# centralities_long %>% 
#   tbl_summary(
#     by = source,
#     statistic = all_continuous2() ~ statistics,
#     digits = all_continuous2() ~ digits,
#     type = everything() ~ "continuous2",
#     include = -district
#   ) %>% 
#   add_stat_label(label = all_continuous() ~ stats_labels)
```

## Exploratory analysis

### Incidence

```{r}
bar_cases <- dataset %>% 
  group_by(new_cases) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  ggplot(aes(new_cases, count)) +
  geom_col(width = 1)

bar_cases
```

```{r}
hist_incidence <- dataset %>% 
  ggplot(aes(incidence)) +
  geom_histogram(bins = 7)

box_incidence <- dataset %>% 
  ggplot(aes(incidence)) +
  geom_boxplot()

hist_incidence / box_incidence
```

```{r}
hist_incidence_log <- dataset %>% 
  ggplot(aes(incidence)) +
  geom_histogram(bins = 7)

box_incidence_log <- dataset %>% 
  ggplot(aes(incidence)) +
  geom_boxplot()

hist_incidence_log / box_incidence_log
```

### Poverty

#### Monetary poverty

```{r}
hist_monetary_poverty <- dataset %>% 
  ggplot(aes(monetary_poverty)) +
  geom_histogram(bins = 7)

box_monetary_poverty <- dataset %>% 
  ggplot(aes(monetary_poverty)) +
  geom_boxplot()

hist_monetary_poverty / box_monetary_poverty
```
#### UBN

```{r}
hist_ubn <- dataset %>% 
  ggplot(aes(ubn)) +
  geom_histogram(bins = 7)

box_ubn <- dataset %>% 
  ggplot(aes(ubn)) +
  geom_boxplot()

hist_ubn / box_ubn
```

### Pollution

#### CO

```{r}
hist_co <- dataset %>% 
  ggplot(aes(co)) +
  geom_histogram(bins = 7)

box_co <- dataset %>% 
  ggplot(aes(co)) +
  geom_boxplot()

hist_co / box_co
```

#### NO2

```{r}
hist_no2 <- dataset %>% 
  ggplot(aes(no2)) +
  geom_histogram(bins = 7)

box_no2 <- dataset %>% 
  ggplot(aes(no2)) +
  geom_boxplot()

hist_no2 / box_no2
```

#### O3

```{r}
hist_o3 <- dataset %>% 
  ggplot(aes(o3)) +
  geom_histogram(bins = 7)

box_o3 <- dataset %>% 
  ggplot(aes(o3)) +
  geom_boxplot()

hist_o3 / box_o3
```

#### PM25

```{r}
hist_pm25 <- dataset %>% 
  ggplot(aes(pm25)) +
  geom_histogram(bins = 7)

box_pm25 <- dataset %>% 
  ggplot(aes(pm25)) +
  geom_boxplot()

hist_pm25 / box_pm25
```

### Intra-communting flow

```{r}
flow_intra_long <- dataset %>% 
  dplyr::select(district, contains("flow")) %>% 
  tidyr::pivot_longer(
    cols = -district,
    names_to = c("source", "variable", "mode"),
    names_sep = "_"
  ) %>% 
  tidyr::pivot_wider(
    id_cols = c(district, source),
    names_from = c(variable, mode),
    values_from = value
  )
```

```{r}
hist_flow_intra <- flow_intra_long %>%  
  ggplot(aes(flow_intra)) +
  geom_histogram(bins = 7) +
  facet_wrap(~source, ncol = 3, scales = "free")

box_flow_intra <- flow_intra_long %>%  
  ggplot(aes(flow_intra)) +
  geom_boxplot() +
  facet_wrap(~source, ncol = 3, scales = "free")
```

```{r fig.width=6}
hist_flow_intra / box_flow_intra
```

### Centrality measures

#### Degree

##### Out-degree

```{r}
hist_degree_out <- centralities_long %>%  
  dplyr::select(source, centrality_degree_out) %>% 
  ggplot(aes(centrality_degree_out)) +
  geom_histogram(bins = 7) +
  facet_wrap(~source, ncol = 3, scales = "free")

box_degree_out <- centralities_long %>%  
  dplyr::select(source, centrality_degree_out) %>% 
  ggplot(aes(centrality_degree_out)) +
  geom_boxplot() +
  facet_wrap(~source, ncol = 3, scales = "free")
```

```{r fig.width=6}
hist_degree_out / box_degree_out
```

#### Strength

##### Out-strength

```{r}
hist_strength_out <- centralities_long %>%  
  dplyr::select(source, centrality_strength_out) %>% 
  ggplot(aes(centrality_strength_out)) +
  geom_histogram(bins = 7) +
  facet_wrap(~source, ncol = 3, scales = "free")

box_strength_out <- centralities_long %>%  
  dplyr::select(source, centrality_strength_out) %>% 
  ggplot(aes(centrality_strength_out)) +
  geom_boxplot() +
  facet_wrap(~source, ncol = 3, scales = "free")
```

```{r fig.width=6}
hist_strength_out / box_strength_out
```

#### Closeness

##### Out-closeness

```{r}
hist_closeness_out <- centralities_long %>%  
  dplyr::select(source, centrality_closeness_out) %>% 
  ggplot(aes(centrality_closeness_out)) +
  geom_histogram(bins = 7) +
  facet_wrap(~source, ncol = 3, scales = "free")

box_closeness_out <- centralities_long %>%  
  dplyr::select(source, centrality_closeness_out) %>% 
  ggplot(aes(centrality_closeness_out)) +
  geom_boxplot() +
  facet_wrap(~source, ncol = 3, scales = "free")
```

```{r fig.width=6}
hist_closeness_out / box_closeness_out
```

#### Betweenness

```{r}
hist_betweenness_directed <- centralities_long %>%  
  dplyr::select(source, centrality_betweenness_directed) %>% 
  ggplot(aes(centrality_betweenness_directed)) +
  geom_histogram(bins = 7) +
  facet_wrap(~source, ncol = 3, scales = "free")

box_betweenness_directed <- centralities_long %>%  
  dplyr::select(source, centrality_betweenness_directed) %>% 
  ggplot(aes(centrality_betweenness_directed)) +
  geom_boxplot() +
  facet_wrap(~source, ncol = 3, scales = "free")
```

```{r fig.width=6}
hist_betweenness_directed / box_betweenness_directed
```

#### Eigenvector

```{r}
hist_eigenvector_directed <- centralities_long %>%  
  dplyr::select(source, centrality_eigenvector_directed) %>% 
  ggplot(aes(centrality_eigenvector_directed)) +
  geom_histogram(bins = 7) +
  facet_wrap(~source, ncol = 3, scales = "free")

box_eigenvector_directed <- centralities_long %>%  
  dplyr::select(source, centrality_eigenvector_directed) %>% 
  ggplot(aes(centrality_eigenvector_directed)) +
  geom_boxplot() +
  facet_wrap(~source, ncol = 3, scales = "free")
```

```{r fig.width=6}
hist_eigenvector_directed / box_eigenvector_directed
```

#### Page-rank

```{r}
hist_pagerank_directed <- centralities_long %>%  
  dplyr::select(source, centrality_pagerank_directed) %>% 
  ggplot(aes(centrality_pagerank_directed)) +
  geom_histogram(bins = 7) +
  facet_wrap(~source, ncol = 3, scales = "free")

box_pagerank_directed <- centralities_long %>%  
  dplyr::select(source, centrality_pagerank_directed) %>% 
  ggplot(aes(centrality_pagerank_directed)) +
  geom_boxplot() +
  facet_wrap(~source, ncol = 3, scales = "free")
```

```{r fig.width=6}
hist_pagerank_directed / box_pagerank_directed
```

# Multivariate analysis

```{r}
dataset %>% 
  dplyr::select(monetary_poverty, ubn, co, no2, o3, pm25) %>% 
  corrr::correlate(quiet = TRUE) %>% 
  corrr::stretch(na.rm = TRUE, remove.dups = TRUE) %>% 
  arrange(-r)
```

# Model building

```{r}
dataset_std = dataset %>% 
  mutate(
    across(
      c(
        monetary_poverty:pm25, full_flow_intra:work_centrality_pagerank_directed,
        ubn
      ),
      ~as.vector(scale(.x))
    )
  )
```


## Base model

```{r}
base_linear_model_formulas = list(
  "poverty-co-o3" = 
    new_cases ~ offset(log(population_permanent)) + monetary_poverty + co + o3,
  "poverty-no2-o3" = 
    new_cases ~ offset(log(population_permanent)) + monetary_poverty + no2 + o3,
  "poverty-pm25-o3" = 
    new_cases ~ offset(log(population_permanent)) + monetary_poverty + pm25 + o3,
  "ubn-co-o3" = 
    new_cases ~ offset(log(population_permanent)) + ubn + co + o3,
  "ubn-no2-o3" = 
    new_cases ~ offset(log(population_permanent)) + ubn + no2 + o3,
  "ubn-pm25-o3" = 
    new_cases ~ offset(log(population_permanent)) + ubn + pm25 + o3
)
```

```{r}
base_linear_model_formulas_df = tibble(
  predictors = names(base_linear_model_formulas), 
  formula = base_linear_model_formulas
)
```

```{r}
base_linear_model_fits = base_linear_model_formulas_df %>% 
  mutate(
    glm_po_fit = purrr::map(
      formula, ~glm(.x, data = dataset_std, family = poisson)
    ),
    glm_nb_fit = purrr::map(
      formula, ~glm.nb(.x, data = dataset_std)
    ),
  ) %>% 
  tidyr::pivot_longer(
    -c(predictors, formula),
    names_to = c("model", "family"),
    names_pattern = "(.*)_(.*)_fit",
    values_to = "fit"
  )
```

```{r}
base_linear_models = base_linear_model_fits %>% 
  mutate(aic = purrr::map(fit, ~AIC(.x))) %>% 
  tidyr::unnest(aic) %>% 
  arrange(aic)

base_linear_models
```

```{r}
summary(base_linear_models$fit[[1]])
```

```{r}
check_overdispersion(base_linear_models$fit[[1]])
```

```{r}
check_collinearity(base_linear_models$fit[[1]])
```

```{r fig.height=8}
check_model(base_linear_models$fit[[1]])
```

```{r}
summary(base_linear_models$fit[[2]])
```

```{r}
check_overdispersion(base_linear_models$fit[[2]])
```

```{r}
check_collinearity(base_linear_models$fit[[2]])
```

```{r fig.height=8}
check_model(base_linear_models$fit[[2]])
```

```{r}
summary(base_linear_models$fit[[3]])
```

```{r}
check_overdispersion(base_linear_models$fit[[3]])
```

```{r}
check_collinearity(base_linear_models$fit[[3]])
```

```{r fig.height=8}
check_model(base_linear_models$fit[[3]])
```

```{r}
base_additive_model_formulas = list(
  "poverty-co-o3" = 
    new_cases ~ offset(log(population_permanent)) + s(monetary_poverty) + s(co) + s(o3),
  "poverty-no2-o3" = 
    new_cases ~ offset(log(population_permanent)) + s(monetary_poverty) + s(no2) + s(o3),
  "poverty-pm25-o3" = 
    new_cases ~ offset(log(population_permanent)) + s(monetary_poverty) + s(pm25) + s(o3),
  "ubn-co-o3" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(co) + s(o3),
  "ubn-no2-o3" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(no2) + s(o3),
  "ubn-pm25-o3" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) + s(o3),
  "poverty-co" = 
    new_cases ~ offset(log(population_permanent)) + s(monetary_poverty) + s(co),
  "poverty-no2" = 
    new_cases ~ offset(log(population_permanent)) + s(monetary_poverty) + s(no2),
  "poverty-pm25" = 
    new_cases ~ offset(log(population_permanent)) + s(monetary_poverty) + s(pm25),
  "poverty-o3" = 
    new_cases ~ offset(log(population_permanent)) + s(monetary_poverty) + s(o3),
  "ubn-co" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(co),
  "ubn-no2" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(no2),
  "ubn-pm25" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25),
  "ubn-o3" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(o3)
)
```

```{r}
base_additive_model_formulas_df = tibble(
  predictors = names(base_additive_model_formulas), 
  formula = base_additive_model_formulas
)
```

```{r}
base_additive_model_fits = base_additive_model_formulas_df %>% 
  mutate(
    gam_po_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = poisson)
    ),
    gam_nb_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = nb())
    ),
  ) %>% 
  tidyr::pivot_longer(
    -c(predictors, formula),
    names_to = c("model", "family"),
    names_pattern = "(.*)_(.*)_fit",
    values_to = "fit"
  )
```

```{r}
base_additive_models = base_additive_model_fits %>% 
  mutate(aic = purrr::map(fit, ~AIC(.x))) %>% 
  tidyr::unnest(aic) %>% 
  arrange(aic)

base_additive_models

# Base model: ubn + pm25
```

```{r}
summary(base_additive_models$fit[[1]])
```

```{r}
check_overdispersion(base_additive_models$fit[[1]])
```

```{r}
plot(check_overdispersion(base_additive_models$fit[[1]]))
```

```{r}
check_concurvity(base_additive_models$fit[[1]])
```

```{r fig.height=8}
gratia::appraise(base_additive_models$fit[[1]])
```

```{r fig.height=8}
gratia::draw(base_additive_models$fit[[1]])
```

```{r}
summary(base_additive_models$fit[[2]])
```

```{r}
check_overdispersion(base_additive_models$fit[[2]])
```

```{r}
plot(check_overdispersion(base_additive_models$fit[[2]]))
```

```{r}
check_concurvity(base_additive_models$fit[[2]])
```

```{r fig.height=8}
gratia::appraise(base_additive_models$fit[[2]])
```

```{r fig.height=8}
gratia::draw(base_additive_models$fit[[2]])
```

```{r}
summary(base_additive_models$fit[[3]])
```

```{r}
check_overdispersion(base_additive_models$fit[[3]])
```

```{r}
plot(check_overdispersion(base_additive_models$fit[[3]]))
```

```{r}
check_concurvity(base_additive_models$fit[[3]])
```

```{r fig.height=8}
gratia::appraise(base_additive_models$fit[[3]])
```

```{r fig.height=8}
gratia::draw(base_additive_models$fit[[3]])
```

```{r}
summary(base_additive_models$fit[[6]])
```

```{r}
check_overdispersion(base_additive_models$fit[[6]])
```

```{r}
plot(check_overdispersion(base_additive_models$fit[[6]]))
```

```{r}
check_concurvity(base_additive_models$fit[[6]])
```

```{r fig.height=8}
gratia::appraise(base_additive_models$fit[[6]])
```

```{r fig.height=8}
gratia::draw(base_additive_models$fit[[6]], residuals = TRUE)
```

```{r}
summary(base_additive_models$fit[[7]])
```

```{r}
check_overdispersion(base_additive_models$fit[[7]])
```

```{r}
plot(check_overdispersion(base_additive_models$fit[[7]]))
```

```{r}
check_concurvity(base_additive_models$fit[[7]])
```

```{r fig.height=8}
gratia::appraise(base_additive_models$fit[[7]])
```

```{r fig.height=8}
gratia::draw(base_additive_models$fit[[7]], residuals = TRUE)
```

## Model with mobilitization variables

### Full

```{r}
# dataset %>% 
#   filter(incidence > 0) %>% 
#   mutate(log_incidence = log(incidence)) %>% 
#   dplyr::select(-c(district, new_cases, population_permanent, incidence)) %>% 
#   corrr::correlate(quiet = TRUE) %>% 
#   corrr::focus(log_incidence) %>% 
#   arrange(-log_incidence) %>% 
#   filter(grepl("centrality|flow", term)) %>% 
#   filter(grepl("full", term))
```

```{r}
dataset_std %>% 
  dplyr::select(
    ubn, no2, o3, full_flow_intra, full_centrality_degree_out, 
    full_centrality_strength_out, full_centrality_closeness_out, 
    full_centrality_betweenness_directed, full_centrality_eigenvector_directed,
    full_centrality_pagerank_directed
  ) %>% 
  # dplyr::select(!dplyr::matches("_log|_yj")) %>%
  corrr::correlate(quiet = TRUE) %>% 
  corrr::stretch(na.rm = TRUE, remove.dups = TRUE) %>% 
  arrange(-r)
```

```{r}
# dataset_trans %>% 
#   dplyr::select(dplyr::contains("full")) %>% 
#   dplyr::select(dplyr::matches("flow|strength_out|eigenvector|pagerank")) %>% 
#   dplyr::select(dplyr::matches("_log")) %>%
#   corrr::correlate(quiet = TRUE) %>% 
#   corrr::stretch(na.rm = TRUE, remove.dups = TRUE) %>% 
#   arrange(r)
```

```{r}
# dataset_trans %>% 
#   dplyr::select(dplyr::contains("full")) %>% 
#   dplyr::select(dplyr::matches("flow|strength_out|eigenvector|pagerank")) %>% 
#   dplyr::select(dplyr::matches("_yj")) %>%
#   corrr::correlate(quiet = TRUE) %>% 
#   corrr::stretch(na.rm = TRUE, remove.dups = TRUE) %>% 
#   arrange(r)
```

```{r}
full_additive_model_formulas = list(
  "full_flow_intra" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(full_flow_intra),
  "full_centrality_degree_out" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(full_centrality_degree_out, k = 4),
  "full_centrality_strength_out" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(full_centrality_strength_out),
  "full_centrality_closeness_out" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(full_centrality_closeness_out),
  "full_centrality_betweenness_directed" =
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(full_centrality_betweenness_directed),
  "full_centrality_eigenvector_directed" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(full_centrality_eigenvector_directed),
  "full_centrality_pagerank_directed" =
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(full_centrality_pagerank_directed)
)
```

```{r}
full_additive_model_formulas_df = tibble(
  predictors = names(full_additive_model_formulas), 
  formula = full_additive_model_formulas
)
```

```{r}
full_additive_model_fits = full_additive_model_formulas_df %>% 
  mutate(
    gam_po_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = poisson)
    ),
    gam_nb_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = nb())
    ),
  ) %>% 
  tidyr::pivot_longer(
    -c(predictors, formula),
    names_to = c("model", "family"),
    names_pattern = "(.*)_(.*)_fit",
    values_to = "fit"
  )
```

```{r}
full_additive_models = full_additive_model_fits %>% 
  mutate(aic = purrr::map(fit, ~AIC(.x))) %>% 
  tidyr::unnest(aic) %>% 
  arrange(aic)

full_additive_models
```

```{r}
summary(full_additive_models$fit[[1]])
```

```{r}
check_overdispersion(full_additive_models$fit[[1]])
```

```{r}
plot(check_overdispersion(full_additive_models$fit[[1]]))
```

```{r}
check_concurvity(full_additive_models$fit[[1]])
```

```{r fig.height=8}
gratia::appraise(full_additive_models$fit[[1]])
```

```{r fig.height=8}
gratia::draw(full_additive_models$fit[[1]], residuals = TRUE)
```

```{r}
summary(full_additive_models$fit[[2]])
```

```{r}
check_overdispersion(full_additive_models$fit[[2]])
```

```{r}
plot(check_overdispersion(full_additive_models$fit[[2]]))
```

```{r}
check_concurvity(full_additive_models$fit[[2]])
```

```{r fig.height=8}
gratia::appraise(full_additive_models$fit[[2]])
```

```{r fig.height=8}
gratia::draw(full_additive_models$fit[[2]])
```

```{r}
summary(full_additive_models$fit[[3]])
```

```{r}
check_overdispersion(full_additive_models$fit[[3]])
```

```{r}
plot(check_overdispersion(full_additive_models$fit[[3]]))
```

```{r}
check_concurvity(full_additive_models$fit[[3]])
```

```{r fig.height=8}
gratia::appraise(full_additive_models$fit[[3]])
```

```{r fig.height=8}
gratia::draw(full_additive_models$fit[[3]])
```

```{r}
summary(full_additive_models$fit[[4]])
```

```{r}
check_overdispersion(full_additive_models$fit[[4]])
```

```{r}
plot(check_overdispersion(full_additive_models$fit[[4]]))
```

```{r}
check_concurvity(full_additive_models$fit[[4]])
```

```{r fig.height=8}
gratia::appraise(full_additive_models$fit[[4]])
```

```{r fig.height=8}
gratia::draw(full_additive_models$fit[[4]])
```

```{r}
summary(full_additive_models$fit[[5]])
```

```{r}
check_overdispersion(full_additive_models$fit[[5]])
```

```{r}
plot(check_overdispersion(full_additive_models$fit[[5]]))
```

```{r}
check_concurvity(full_additive_models$fit[[5]])
```

```{r fig.height=8}
gratia::appraise(full_additive_models$fit[[5]])
```

```{r fig.height=8}
gratia::draw(full_additive_models$fit[[5]])
```

```{r}
summary(full_additive_models$fit[[6]])
```

```{r}
check_overdispersion(full_additive_models$fit[[6]])
```

```{r}
plot(check_overdispersion(full_additive_models$fit[[6]]))
```

```{r}
check_concurvity(full_additive_models$fit[[6]])
```

```{r fig.height=8}
gratia::appraise(full_additive_models$fit[[6]])
```

```{r fig.height=8}
gratia::draw(full_additive_models$fit[[6]])
```

### Study

```{r}
study_additive_model_formulas = list(
  "study_flow_intra" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(study_flow_intra),
  "study_centrality_degree_out" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(study_centrality_degree_out, k = 4),
  "study_centrality_strength_out" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(study_centrality_strength_out),
  "study_centrality_closeness_out" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(study_centrality_closeness_out),
  "study_centrality_betweenness_directed" =
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(study_centrality_betweenness_directed),
  "study_centrality_eigenvector_directed" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(study_centrality_eigenvector_directed),
  "study_centrality_pagerank_directed" =
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(study_centrality_pagerank_directed)
)
```

```{r}
study_additive_model_formulas_df = tibble(
  predictors = names(study_additive_model_formulas), 
  formula = study_additive_model_formulas
)
```

```{r}
study_additive_model_fits = study_additive_model_formulas_df %>% 
  mutate(
    gam_po_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = poisson)
    ),
    gam_nb_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = nb())
    ),
  ) %>% 
  tidyr::pivot_longer(
    -c(predictors, formula),
    names_to = c("model", "family"),
    names_pattern = "(.*)_(.*)_fit",
    values_to = "fit"
  )
```

```{r}
study_additive_models = study_additive_model_fits %>% 
  mutate(aic = purrr::map(fit, ~AIC(.x))) %>% 
  tidyr::unnest(aic) %>% 
  arrange(aic)

study_additive_models
```

```{r}
summary(study_additive_models$fit[[1]])
```

```{r}
check_overdispersion(study_additive_models$fit[[1]])
```

```{r}
plot(check_overdispersion(study_additive_models$fit[[1]]))
```

```{r}
check_concurvity(study_additive_models$fit[[1]])
```

```{r fig.height=8}
gratia::appraise(study_additive_models$fit[[1]])
```

```{r fig.height=8}
gratia::draw(study_additive_models$fit[[1]])
```

```{r}
summary(study_additive_models$fit[[2]])
```

```{r}
check_overdispersion(study_additive_models$fit[[2]])
```

```{r}
plot(check_overdispersion(study_additive_models$fit[[2]]))
```

```{r}
check_concurvity(study_additive_models$fit[[2]])
```

```{r fig.height=8}
gratia::appraise(study_additive_models$fit[[2]])
```

```{r fig.height=8}
gratia::draw(study_additive_models$fit[[2]])
```

### Work

```{r}
work_additive_model_formulas = list(
  "work_flow_intra" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(work_flow_intra),
  "work_centrality_degree_out" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(work_centrality_degree_out, k = 4),
  "work_centrality_strength_out" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(work_centrality_strength_out),
  "work_centrality_closeness_out" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(work_centrality_closeness_out),
  "work_centrality_betweenness_directed" =
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(work_centrality_betweenness_directed),
  "work_centrality_eigenvector_directed" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(work_centrality_eigenvector_directed),
  "work_centrality_pagerank_directed" =
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(work_centrality_pagerank_directed)
)
```

```{r}
work_additive_model_formulas_df = tibble(
  predictors = names(work_additive_model_formulas), 
  formula = work_additive_model_formulas
)
```

```{r}
work_additive_model_fits = work_additive_model_formulas_df %>% 
  mutate(
    gam_po_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = poisson)
    ),
    gam_nb_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = nb())
    ),
  ) %>% 
  tidyr::pivot_longer(
    -c(predictors, formula),
    names_to = c("model", "family"),
    names_pattern = "(.*)_(.*)_fit",
    values_to = "fit"
  )
```

```{r}
work_additive_models = work_additive_model_fits %>% 
  mutate(aic = purrr::map(fit, ~AIC(.x))) %>% 
  tidyr::unnest(aic) %>% 
  arrange(aic)

work_additive_models
```

```{r}
work_additive_models = work_additive_model_fits %>% 
  mutate(aic = purrr::map(fit, ~AIC(.x))) %>% 
  tidyr::unnest(aic) %>% 
  arrange(aic)

work_additive_models
```

```{r}
summary(work_additive_models$fit[[1]])
```

```{r}
check_overdispersion(work_additive_models$fit[[1]])
```

```{r}
plot(check_overdispersion(work_additive_models$fit[[1]]))
```

```{r}
check_concurvity(work_additive_models$fit[[1]])
```

```{r fig.height=8}
gratia::appraise(work_additive_models$fit[[1]])
```

```{r fig.height=8}
gratia::draw(work_additive_models$fit[[1]])
```

```{r}
summary(work_additive_models$fit[[2]])
```

```{r}
check_overdispersion(work_additive_models$fit[[2]])
```

```{r}
plot(check_overdispersion(work_additive_models$fit[[2]]))
```

```{r}
check_concurvity(work_additive_models$fit[[2]])
```

```{r fig.height=8}
gratia::appraise(work_additive_models$fit[[2]])
```

```{r fig.height=8}
gratia::draw(work_additive_models$fit[[2]])
```

## Save models

```{r}
models_path = "data/processed/models/"
full_filename = "full-models.rds"
study_filename = "study-models.rds"
work_filename = "work-models.rds"
full_filepath = fs::path(models_path, full_filename)
study_filepath = fs::path(models_path, study_filename)
work_filepath = fs::path(models_path, work_filename)
saveRDS(full_additive_models, full_filepath)
saveRDS(study_additive_models, study_filepath)
saveRDS(work_additive_models, work_filepath)
```

