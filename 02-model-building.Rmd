---
title: "Model building"
output:
  html_document:
    df_print: paged
---

`00-network-analysis.Rmd`: Para cada tipo de movilidad (estudios, trabajo y ambos) y para todos los distritos (42, no se incluyó Pueblo Libre) se calculó:

- Scores de centralidad (strength, closeness, betweenness, eigenvector, page-rank). 
- Flujo intradistrital de personas (cuántas personas se movilizan en el mismo distrito).

```{r}
library(dplyr)
library(ggplot2)
library(patchwork)
library(MASS)
library(performance)
library(mgcv)
# library(flextable)
# library(cowplot)
# library(ggsci)
```

```{r}
processed_path = "data/processed/"
centralities_filename = "centralities.csv"
centralities_filepath = fs::path(processed_path, centralities_filename)
centralities = readr::read_csv(centralities_filepath, col_types = "ccccd")
```

```{r}
glimpse(centralities)
```

# Data wrangling

```{r}
dataset = centralities |> 
  mutate(
    incidence = new_cases / population_permanent,
    ubn = hh_1_nbi_or_more / number_hh
  ) |> 
  dplyr::select(
    -c(
      department:province, ubigeo, idh, life_expectancy:family_income, 
      number_hh:aai, ntl, so2, tmmn, tmmx
    )
  )
```

```{r}
glimpse(dataset)
```

# Multivariate analysis

```{r}
dataset |> 
  dplyr::select(monetary_poverty, ubn, co, no2, o3, pm25) |> 
  corrr::correlate(quiet = TRUE) |> 
  corrr::stretch(na.rm = TRUE, remove.dups = TRUE) |> 
  arrange(-r)
```

# Model building

```{r}
dataset_std = dataset |> 
  mutate(
    across(
      c(
        monetary_poverty:pm25, full_flow_intra:work_centrality_pagerank_directed,
        ubn
      ),
      ~as.vector(scale(.x))
    )
  )
```

## GLM

```{r}
glm_base_formulas_list = list(
  "poverty-co" = 
    new_cases ~ offset(log(population_permanent)) + monetary_poverty + co,
  "poverty-no2" = 
    new_cases ~ offset(log(population_permanent)) + monetary_poverty + no2,
  "poverty-pm25" = 
    new_cases ~ offset(log(population_permanent)) + monetary_poverty + pm25,
  "poverty-o3" = 
    new_cases ~ offset(log(population_permanent)) + monetary_poverty + o3,
  "ubn-co" = 
    new_cases ~ offset(log(population_permanent)) + ubn + co,
  "ubn-no2" = 
    new_cases ~ offset(log(population_permanent)) + ubn + no2,
  "ubn-pm25" = 
    new_cases ~ offset(log(population_permanent)) + ubn + pm25,
  "ubn-o3" = 
    new_cases ~ offset(log(population_permanent)) + ubn + o3
)
```

```{r}
glm_base_formulas = tibble(
  base = names(glm_base_formulas_list), 
  formula = glm_base_formulas_list
)
```

### Full

```{r}
full_mobility = c(
  "full_flow_intra", "full_centrality_strength_out",
  "full_centrality_closeness_out", "full_centrality_betweenness_directed",
  "full_centrality_eigenvector_directed", "full_centrality_pagerank_directed"
)
```

```{r}
glm_full_mobility_design = expand.grid(
  base = names(glm_base_formulas_list), mobility = full_mobility
) |> 
  arrange(base)
```

```{r}
glm_full_mobility_formulas_raw = glm_full_mobility_design |> 
  inner_join(glm_base_formulas, by = c("base"))
```

```{r}
glm_full_mobility_formulas = glm_full_mobility_formulas_raw |> 
  mutate(
    formula = purrr::map2(
      formula, as.list(mobility),
      ~update.formula(.x, as.formula(sprintf("~ . + %s", .y)))
    )
  ) 
```

```{r}
glm_full_formulas = bind_rows(glm_base_formulas, glm_full_mobility_formulas)
```

```{r}
glm_full_fits = glm_full_formulas |> 
  mutate(
    glm_po_fit = purrr::map(
      formula, ~glm(.x, data = dataset, family = poisson)
    ),
    glm_nb_fit = purrr::map(
      formula, ~glm.nb(.x, data = dataset)
    ),
  ) |> 
  tidyr::pivot_longer(
    -c(base, mobility, formula),
    names_to = c("model", "family"),
    names_pattern = "(.*)_(.*)_fit",
    values_to = "fit"
  )
```

```{r}
glm_full_performance = glm_full_fits |> 
  mutate(aic = purrr::map(fit, ~AIC(.x))) |> 
  tidyr::unnest(aic) |> 
  arrange(aic)

glm_full_performance
```

```{r}
summary(glm_full_performance$fit[[1]])
```

```{r}
tibble(model_performance(glm_full_performance$fit[[1]]))
```

```{r}
check_overdispersion(glm_full_performance$fit[[1]])
```

```{r}
check_collinearity(glm_full_performance$fit[[1]])
```

```{r message=false, warning=false, fig.height=8}
check_model(glm_full_performance$fit[[1]])
```

```{r}
pr <- ggeffects::ggpredict(glm_full_performance$fit[[1]], "monetary_poverty [all]")
plot(pr, residuals = TRUE)
```


```{r}
summary(glm_full_performance$fit[[2]])
```

```{r}
check_overdispersion(glm_full_performance$fit[[2]])
```

```{r}
check_collinearity(glm_full_performance$fit[[2]])
```

```{r message=false, warning=false, fig.height=8}
check_model(glm_full_performance$fit[[2]])
```

```{r}
summary(glm_full_performance$fit[[3]])
```
```{r}
check_overdispersion(glm_full_performance$fit[[3]])
```

```{r}
check_collinearity(glm_full_performance$fit[[3]])
```

```{r message=false, warning=false, fig.height=8}
check_model(glm_full_performance$fit[[3]])
```

### Study

```{r}
study_mobility = c(
  "study_flow_intra", "study_centrality_strength_out",
  "study_centrality_closeness_out",
  "study_centrality_betweenness_directed",
  "study_centrality_eigenvector_directed", 
  "study_centrality_pagerank_directed"
)
```

```{r}
glm_study_mobility_design = expand.grid(
  base = names(glm_base_formulas_list), mobility = study_mobility
) |> 
  arrange(base)
```

```{r}
glm_study_mobility_formulas_raw = glm_study_mobility_design |> 
  inner_join(glm_base_formulas, by = c("base"))
```

```{r}
glm_study_mobility_formulas = glm_study_mobility_formulas_raw |> 
  mutate(
    formula = purrr::map2(
      formula, as.list(mobility),
      ~update.formula(.x, as.formula(sprintf("~ . + %s", .y)))
    )
  ) 
```

```{r}
glm_study_formulas = bind_rows(glm_base_formulas, glm_study_mobility_formulas)
```

```{r}
glm_study_fits = glm_study_formulas |> 
  mutate(
    glm_po_fit = purrr::map(
      formula, ~glm(.x, data = dataset_std, family = poisson)
    ),
    glm_nb_fit = purrr::map(
      formula, ~glm.nb(.x, data = dataset_std)
    ),
  ) |> 
  tidyr::pivot_longer(
    -c(base, mobility, formula),
    names_to = c("model", "family"),
    names_pattern = "(.*)_(.*)_fit",
    values_to = "fit"
  )
```

```{r}
glm_study_performance = glm_study_fits |> 
  mutate(aic = purrr::map(fit, ~AIC(.x))) |> 
  tidyr::unnest(aic) |> 
  arrange(aic)

glm_study_performance
```

```{r}
summary(glm_study_performance$fit[[1]])
```

```{r}
model_performance(glm_study_performance$fit[[1]])
```

```{r}
check_overdispersion(glm_study_performance$fit[[1]])
```

```{r}
check_collinearity(glm_study_performance$fit[[1]])
```

```{r message=false, warning=false, fig.height=8}
check_model(glm_study_performance$fit[[1]])
```

```{r}
summary(glm_study_performance$fit[[2]])
```

```{r}
check_overdispersion(glm_study_performance$fit[[2]])
```

```{r}
check_collinearity(glm_study_performance$fit[[2]])
```

```{r message=false, warning=false, fig.height=8}
check_model(glm_study_performance$fit[[2]])
```

```{r}
summary(glm_study_performance$fit[[3]])
```

```{r}
check_overdispersion(glm_study_performance$fit[[3]])
```

```{r}
check_collinearity(glm_study_performance$fit[[3]])
```

```{r message=false, warning=false, fig.height=8}
check_model(glm_study_performance$fit[[3]])
```

### Work

```{r}
work_mobility = c(
  "work_flow_intra", "work_centrality_strength_out",
  "work_centrality_closeness_out", "work_centrality_betweenness_directed",
  "work_centrality_eigenvector_directed", "work_centrality_pagerank_directed"
)
```

```{r}
glm_work_mobility_design = expand.grid(
  base = names(glm_base_formulas_list), mobility = work_mobility
) |> 
  arrange(base)
```

```{r}
glm_work_mobility_formulas_raw = glm_work_mobility_design |> 
  inner_join(glm_base_formulas, by = c("base"))
```

```{r}
glm_work_mobility_formulas = glm_work_mobility_formulas_raw |> 
  mutate(
    formula = purrr::map2(
      formula, as.list(mobility),
      ~update.formula(.x, as.formula(sprintf("~ . + %s", .y)))
    )
  ) 
```

```{r}
glm_work_formulas = bind_rows(glm_base_formulas, glm_work_mobility_formulas)
```

```{r}
glm_work_fits = glm_work_formulas |> 
  mutate(
    glm_po_fit = purrr::map(
      formula, ~glm(.x, data = dataset_std, family = poisson)
    ),
    glm_nb_fit = purrr::map(
      formula, ~glm.nb(.x, data = dataset_std)
    ),
  ) |> 
  tidyr::pivot_longer(
    -c(base, mobility, formula),
    names_to = c("model", "family"),
    names_pattern = "(.*)_(.*)_fit",
    values_to = "fit"
  )
```

```{r}
glm_work_performance = glm_work_fits |> 
  mutate(aic = purrr::map(fit, ~AIC(.x))) |> 
  tidyr::unnest(aic) |> 
  arrange(aic)

glm_work_performance
```

```{r}
summary(glm_work_performance$fit[[1]])
```

```{r}
model_performance(glm_work_performance$fit[[1]])
```

```{r}
check_overdispersion(glm_work_performance$fit[[1]])
```

```{r}
check_collinearity(glm_work_performance$fit[[1]])
```

```{r message=false, warning=false, fig.height=8}
check_model(glm_work_performance$fit[[1]])
```

```{r}
summary(glm_work_performance$fit[[2]])
```

```{r}
check_overdispersion(glm_work_performance$fit[[2]])
```

```{r}
check_collinearity(glm_work_performance$fit[[2]])
```

```{r fig.height=8}
check_model(glm_work_performance$fit[[2]])
```

```{r}
summary(glm_work_performance$fit[[3]])
```

```{r}
check_overdispersion(glm_work_performance$fit[[3]])
```

```{r}
check_collinearity(glm_work_performance$fit[[3]])
```

```{r message=false, warning=false, fig.height=8}
check_model(glm_work_performance$fit[[3]])
```

## GAM

```{r}
gam_base_formulas_list = list(
  "poverty-co" = 
    new_cases ~ offset(log(population_permanent)) + s(monetary_poverty) + s(co),
  "poverty-no2" = 
    new_cases ~ offset(log(population_permanent)) + s(monetary_poverty) + 
    s(no2),
  "poverty-pm25" = 
    new_cases ~ offset(log(population_permanent)) + s(monetary_poverty) + 
    s(pm25),
  "poverty-o3" = 
    new_cases ~ offset(log(population_permanent)) + s(monetary_poverty) + 
    s(o3),
  "ubn-co" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(co),
  "ubn-no2" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(no2),
  "ubn-pm25" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25),
  "ubn-o3" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(o3)
)
```

```{r}
gam_base_formulas = tibble(
  base = names(gam_base_formulas_list), 
  formula = gam_base_formulas_list
)
```

### Full

```{r}
gam_full_mobility_design = expand.grid(
  base = names(gam_base_formulas_list), mobility = full_mobility
) |> 
  arrange(base)
```

```{r}
gam_full_mobility_formulas_raw = gam_full_mobility_design |> 
  inner_join(gam_base_formulas, by = c("base"))
```

```{r}
gam_full_mobility_formulas = gam_full_mobility_formulas_raw |> 
  mutate(
    formula = purrr::map2(
      formula, as.list(mobility),
      ~update.formula(.x, as.formula(sprintf("~ . + s(%s)", .y)))
    )
  ) 
```

```{r}
gam_full_formulas = bind_rows(gam_base_formulas, gam_full_mobility_formulas)
```

```{r}
gam_full_fits = gam_full_formulas |> 
  mutate(
    gam_po_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = poisson, method = "REML")
    ),
    gam_nb_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = nb(), method = "REML")
    ),
  ) |> 
  tidyr::pivot_longer(
    -c(base, mobility, formula),
    names_to = c("model", "family"),
    names_pattern = "(.*)_(.*)_fit",
    values_to = "fit"
  )
```

```{r}
gam_full_performance = gam_full_fits |> 
  mutate(aic = purrr::map(fit, ~AIC(.x))) |> 
  tidyr::unnest(aic) |> 
  arrange(aic)

gam_full_performance
```

```{r}
summary(gam_full_performance$fit[[1]])
```

```{r}
tibble(model_performance(gam_full_performance$fit[[1]]))
```

```{r}
check_overdispersion(gam_full_performance$fit[[1]])
```

```{r}
check_concurvity(gam_full_performance$fit[[1]])
```

```{r}
gratia::appraise(gam_full_performance$fit[[1]])
```

```{r}
gratia::draw(gam_full_performance$fit[[1]])
```

```{r}
gam.check(gam_full_performance$fit[[1]])
```

```{r}
summary(gam_full_performance$fit[[2]])
```

```{r}
tibble(model_performance(gam_full_performance$fit[[2]]))
```

```{r}
check_overdispersion(gam_full_performance$fit[[2]])
```

```{r}
check_concurvity(gam_full_performance$fit[[2]])
```

```{r}
gratia::appraise(gam_full_performance$fit[[2]])
```

```{r}
gratia::draw(gam_full_performance$fit[[2]], residuals = TRUE)
```

```{r}
gam.check(gam_full_performance$fit[[2]])
```


### Study

```{r}
gam_study_mobility_design = expand.grid(base = base, mobility = study_mobility) |> 
  arrange(base)
```

```{r}
gam_study_mobility_formulas_raw = gam_study_mobility_design |> 
  inner_join(gam_base_formulas, by = c("base"))
```

```{r}
gam_study_mobility_formulas = gam_study_mobility_formulas_raw |> 
  mutate(
    formula = purrr::map2(
      formula, as.list(mobility),
      ~update.formula(.x, as.formula(sprintf("~ . + s(%s, k = 5)", .y)))
    )
  ) 
```

```{r}
gam_study_formulas = bind_rows(gam_base_formulas, gam_study_mobility_formulas)
```

```{r}
gam_study_fits = gam_study_formulas |> 
  mutate(
    gam_po_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = poisson)
    ),
    gam_nb_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = nb())
    ),
  ) |> 
  tidyr::pivot_longer(
    -c(base, mobility, formula),
    names_to = c("model", "family"),
    names_pattern = "(.*)_(.*)_fit",
    values_to = "fit"
  )
```

```{r}
gam_study_performance = gam_study_fits |> 
  mutate(aic = purrr::map(fit, ~AIC(.x))) |> 
  tidyr::unnest(aic) |> 
  arrange(aic)

gam_study_performance
```

### Work

```{r}
gam_work_mobility_design = expand.grid(base = base, mobility = work_mobility) |> 
  arrange(base)
```

```{r}
gam_work_mobility_formulas_raw = gam_work_mobility_design |> 
  inner_join(gam_base_formulas, by = c("base"))
```

```{r}
gam_work_mobility_formulas = gam_work_mobility_formulas_raw |> 
  mutate(
    formula = purrr::map2(
      formula, as.list(mobility),
      ~update.formula(.x, as.formula(sprintf("~ . + s(%s, k = 5)", .y)))
    )
  ) 
```

```{r}
gam_work_formulas = bind_rows(gam_base_formulas, gam_work_mobility_formulas)
```

```{r}
gam_work_fits = gam_work_formulas |> 
  mutate(
    gam_po_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = poisson)
    ),
    gam_nb_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = nb())
    ),
  ) |> 
  tidyr::pivot_longer(
    -c(base, mobility, formula),
    names_to = c("model", "family"),
    names_pattern = "(.*)_(.*)_fit",
    values_to = "fit"
  )
```

```{r}
gam_work_performance = gam_work_fits |> 
  mutate(aic = purrr::map(fit, ~AIC(.x))) |> 
  tidyr::unnest(aic) |> 
  arrange(aic)

gam_work_performance
```

# Legacy

```{r}
gam_full_base_intra = gam_base

names(gam_full_base_intra) = purrr::map(
  names(gam_full_base_intra), ~paste0(.x, "-full_flow_intra")
)

gam_full_base_intra = purrr::map(
gam_full_base_intra, ~update.formula(.x, ~ . + s(full_flow_intra))
)
```

```{r}
gam_full_base_degree_out = gam_base

names(gam_full_base_degree_out) = purrr::map(
  names(gam_full_base_degree_out), 
  ~paste0(.x, "-full_centrality_degree_out")
)

gam_full_base_degree_out = purrr::map(
  gam_full_base_degree_out, 
  ~update.formula(.x, ~ . + s(full_centrality_degree_out, k = 4))
)
```

```{r}
gam_full_base_strength_out = gam_base

names(gam_full_base_strength_out) = purrr::map(
  names(gam_full_base_strength_out), 
  ~paste0(.x, "-full_centrality_strength_out")
)

gam_full_base_strength_out = purrr::map(
  gam_full_base_strength_out, 
  ~update.formula(.x, ~ . + s(full_centrality_strength_out))
)
```

```{r}
gam_full_base_closeness_out = gam_base

names(gam_full_base_closeness_out) = purrr::map(
  names(gam_full_base_closeness_out), 
  ~paste0(.x, "-full_centrality_closeness_out")
)

gam_full_base_closeness_out = purrr::map(
  gam_full_base_closeness_out, 
  ~update.formula(.x, ~ . + s(full_centrality_closeness_out))
)
```

```{r}
gam_full_base_betweenness_directed = gam_base

names(gam_full_base_betweenness_directed) = purrr::map(
  names(gam_full_base_betweenness_directed), 
  ~paste0(.x, "-full_centrality_betweenness_directed")
)

gam_full_base_betweenness_directed = purrr::map(
  gam_full_base_betweenness_directed, 
  ~update.formula(.x, ~ . + s(full_centrality_betweenness_directed))
)
```

```{r}
gam_full_base_eigenvector_directed = gam_base

names(gam_full_base_eigenvector_directed) = purrr::map(
  names(gam_full_base_eigenvector_directed), 
  ~paste0(.x, "-full_centrality_eigenvector_directed")
)

gam_full_base_eigenvector_directed = purrr::map(
  gam_full_base_eigenvector_directed, 
  ~update.formula(.x, ~ . + s(full_centrality_eigenvector_directed))
)
```

```{r}
gam_full_base_pagerank_directed = gam_base

names(gam_full_base_pagerank_directed) = purrr::map(
  names(gam_full_base_pagerank_directed), 
  ~paste0(.x, "-full_centrality_pagerank_directed")
)

gam_full_base_pagerank_directed = purrr::map(
  gam_full_base_pagerank_directed, 
  ~update.formula(.x, ~ . + s(full_centrality_pagerank_directed))
)
```

```{r}
gam_full_base_mobility = c(
  gam_base, gam_full_base_intra, gam_full_base_degree_out,
  gam_full_base_strength_out, gam_full_base_closeness_out,
  gam_full_base_betweenness_directed, gam_full_base_eigenvector_directed,
  gam_full_base_pagerank_directed
)
```

```{r}
gam_full_base_mobility_df = tibble(
  predictors = names(gam_full_base_mobility), 
  formula = gam_full_base_mobility
)
```

```{r}
gam_full_base_mobility_fits = gam_full_base_mobility_df |> 
  mutate(
    gam_po_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = poisson)
    ),
    gam_nb_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = nb())
    ),
  ) |> 
  tidyr::pivot_longer(
    -c(predictors, formula),
    names_to = c("model", "family"),
    names_pattern = "(.*)_(.*)_fit",
    values_to = "fit"
  )
```

```{r}
gam_full_base_mobility_results = gam_full_base_mobility_fits |> 
  mutate(aic = purrr::map(fit, ~AIC(.x))) |> 
  tidyr::unnest(aic) |> 
  arrange(aic)

gam_full_base_mobility_results
```

```{r}
summary(gam_full_base_mobility_results$fit[[1]])
```

```{r}
check_overdispersion(gam_full_base_mobility_results$fit[[1]])
```

```{r}
plot(check_overdispersion(gam_full_base_mobility_results$fit[[1]]))
```

```{r}
check_concurvity(gam_full_base_mobility_results$fit[[1]])
```

```{r fig.height=8}
gratia::appraise(gam_full_base_mobility_results$fit[[1]])
```

```{r fig.height=8}
gratia::draw(gam_full_base_mobility_results$fit[[1]])
```

```{r}
summary(gam_full_base_mobility_results$fit[[2]])
```

```{r}
check_overdispersion(gam_full_base_mobility_results$fit[[2]])
```

```{r}
plot(check_overdispersion(gam_full_base_mobility_results$fit[[2]]))
```

```{r}
check_concurvity(gam_full_base_mobility_results$fit[[2]])
```

```{r fig.height=8}
gratia::appraise(gam_full_base_mobility_results$fit[[2]])
```

```{r fig.height=8}
gratia::draw(gam_full_base_mobility_results$fit[[2]])
```

```{r}
summary(gam_full_base_mobility_results$fit[[3]])
```

```{r}
check_overdispersion(gam_full_base_mobility_results$fit[[3]])
```

```{r}
plot(check_overdispersion(gam_full_base_mobility_results$fit[[3]]))
```

```{r}
check_concurvity(gam_full_base_mobility_results$fit[[3]])
```

```{r fig.height=8}
gratia::appraise(gam_full_base_mobility_results$fit[[3]])
```

```{r fig.height=8}
gratia::draw(gam_full_base_mobility_results$fit[[3]])
```

```{r}
summary(gam_full_base_mobility_results$fit[[6]])
```

```{r}
check_overdispersion(gam_full_base_mobility_results$fit[[6]])
```

```{r}
plot(check_overdispersion(gam_full_base_mobility_results$fit[[6]]))
```

```{r}
check_concurvity(gam_full_base_mobility_results$fit[[6]])
```

```{r fig.height=8}
gratia::appraise(gam_full_base_mobility_results$fit[[6]])
```

```{r fig.height=8}
gratia::draw(gam_full_base_mobility_results$fit[[6]], residuals = TRUE)
```

```{r}
summary(gam_full_base_mobility_results$fit[[7]])
```

```{r}
check_overdispersion(gam_full_base_mobility_results$fit[[7]])
```

```{r}
plot(check_overdispersion(gam_full_base_mobility_results$fit[[7]]))
```

```{r}
check_concurvity(gam_full_base_mobility_results$fit[[7]])
```

```{r fig.height=8}
gratia::appraise(gam_full_base_mobility_results$fit[[7]])
```

```{r fig.height=8}
gratia::draw(gam_full_base_mobility_results$fit[[7]], residuals = TRUE)
```

### Study

```{r}
gam_study_base_intra = gam_base

names(gam_study_base_intra) = purrr::map(
  names(gam_study_base_intra), ~paste0(.x, "-study_flow_intra")
)

gam_study_base_intra = purrr::map(
gam_study_base_intra, ~update.formula(.x, ~ . + s(study_flow_intra))
)
```

```{r}
gam_study_base_degree_out = gam_base

names(gam_study_base_degree_out) = purrr::map(
  names(gam_study_base_degree_out), 
  ~paste0(.x, "-study_centrality_degree_out")
)

gam_study_base_degree_out = purrr::map(
  gam_study_base_degree_out, 
  ~update.formula(.x, ~ . + s(study_centrality_degree_out, k = 4))
)
```

```{r}
gam_study_base_strength_out = gam_base

names(gam_study_base_strength_out) = purrr::map(
  names(gam_study_base_strength_out), 
  ~paste0(.x, "-study_centrality_strength_out")
)

gam_study_base_strength_out = purrr::map(
  gam_study_base_strength_out, 
  ~update.formula(.x, ~ . + s(study_centrality_strength_out))
)
```

```{r}
gam_study_base_closeness_out = gam_base

names(gam_study_base_closeness_out) = purrr::map(
  names(gam_study_base_closeness_out), 
  ~paste0(.x, "-study_centrality_closeness_out")
)

gam_study_base_closeness_out = purrr::map(
  gam_study_base_closeness_out, 
  ~update.formula(.x, ~ . + s(study_centrality_closeness_out))
)
```

```{r}
gam_study_base_betweenness_directed = gam_base

names(gam_study_base_betweenness_directed) = purrr::map(
  names(gam_study_base_betweenness_directed), 
  ~paste0(.x, "-study_centrality_betweenness_directed")
)

gam_study_base_betweenness_directed = purrr::map(
  gam_study_base_betweenness_directed, 
  ~update.formula(.x, ~ . + s(study_centrality_betweenness_directed))
)
```

```{r}
gam_study_base_eigenvector_directed = gam_base

names(gam_study_base_eigenvector_directed) = purrr::map(
  names(gam_study_base_eigenvector_directed), 
  ~paste0(.x, "-study_centrality_eigenvector_directed")
)

gam_study_base_eigenvector_directed = purrr::map(
  gam_study_base_eigenvector_directed, 
  ~update.formula(.x, ~ . + s(study_centrality_eigenvector_directed))
)
```

```{r}
gam_study_base_pagerank_directed = gam_base

names(gam_study_base_pagerank_directed) = purrr::map(
  names(gam_study_base_pagerank_directed), 
  ~paste0(.x, "-study_centrality_pagerank_directed")
)

gam_study_base_pagerank_directed = purrr::map(
  gam_study_base_pagerank_directed, 
  ~update.formula(.x, ~ . + s(study_centrality_pagerank_directed))
)
```

```{r}
gam_study_base_mobility = c(
  gam_base, gam_study_base_intra, gam_study_base_degree_out,
  gam_study_base_strength_out, gam_study_base_closeness_out,
  gam_study_base_betweenness_directed, gam_study_base_eigenvector_directed,
  gam_study_base_pagerank_directed
)
```

```{r}
gam_study_base_mobility_df = tibble(
  predictors = names(gam_study_base_mobility), 
  formula = gam_study_base_mobility
)
```

```{r}
gam_study_base_mobility_fits = gam_study_base_mobility_df |> 
  mutate(
    gam_po_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = poisson)
    ),
    gam_nb_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = nb())
    ),
  ) |> 
  tidyr::pivot_longer(
    -c(predictors, formula),
    names_to = c("model", "family"),
    names_pattern = "(.*)_(.*)_fit",
    values_to = "fit"
  )
```

```{r}
gam_study_base_mobility_results = gam_study_base_mobility_fits |> 
  mutate(aic = purrr::map(fit, ~AIC(.x))) |> 
  tidyr::unnest(aic) |> 
  arrange(aic)

gam_study_base_mobility_results
```

```{r}
summary(gam_study_base_mobility_results$fit[[1]])
```

```{r}
check_overdispersion(gam_study_base_mobility_results$fit[[1]])
```

```{r}
plot(check_overdispersion(gam_study_base_mobility_results$fit[[1]]))
```

```{r}
check_concurvity(gam_study_base_mobility_results$fit[[1]])
```

```{r fig.height=8}
gratia::appraise(gam_study_base_mobility_results$fit[[1]])
```

```{r fig.height=8}
gratia::draw(gam_study_base_mobility_results$fit[[1]])
```

```{r}
summary(gam_study_base_mobility_results$fit[[2]])
```

```{r}
check_overdispersion(gam_study_base_mobility_results$fit[[2]])
```

```{r}
plot(check_overdispersion(gam_study_base_mobility_results$fit[[2]]))
```

```{r}
check_concurvity(gam_study_base_mobility_results$fit[[2]])
```

```{r fig.height=8}
gratia::appraise(gam_study_base_mobility_results$fit[[2]])
```

```{r fig.height=8}
gratia::draw(gam_study_base_mobility_results$fit[[2]])
```

```{r}
summary(gam_study_base_mobility_results$fit[[3]])
```

```{r}
check_overdispersion(gam_study_base_mobility_results$fit[[3]])
```

```{r}
plot(check_overdispersion(gam_study_base_mobility_results$fit[[3]]))
```

```{r}
check_concurvity(gam_study_base_mobility_results$fit[[3]])
```

```{r fig.height=8}
gratia::appraise(gam_study_base_mobility_results$fit[[3]])
```

```{r fig.height=8}
gratia::draw(gam_study_base_mobility_results$fit[[3]])
```

```{r}
summary(gam_study_base_mobility_results$fit[[6]])
```

```{r}
check_overdispersion(gam_study_base_mobility_results$fit[[6]])
```

```{r}
plot(check_overdispersion(gam_study_base_mobility_results$fit[[6]]))
```

```{r}
check_concurvity(gam_study_base_mobility_results$fit[[6]])
```

```{r fig.height=8}
gratia::appraise(gam_study_base_mobility_results$fit[[6]])
```

```{r fig.height=8}
gratia::draw(gam_study_base_mobility_results$fit[[6]], residuals = TRUE)
```

```{r}
summary(gam_study_base_mobility_results$fit[[7]])
```

```{r}
check_overdispersion(gam_study_base_mobility_results$fit[[7]])
```

```{r}
plot(check_overdispersion(gam_study_base_mobility_results$fit[[7]]))
```

```{r}
check_concurvity(gam_study_base_mobility_results$fit[[7]])
```

```{r fig.height=8}
gratia::appraise(gam_study_base_mobility_results$fit[[7]])
```

```{r fig.height=8}
gratia::draw(gam_study_base_mobility_results$fit[[7]], residuals = TRUE)
```

### Work

```{r}
gam_work_base_intra = gam_base

names(gam_work_base_intra) = purrr::map(
  names(gam_work_base_intra), ~paste0(.x, "-work_flow_intra")
)

gam_work_base_intra = purrr::map(
gam_work_base_intra, ~update.formula(.x, ~ . + s(work_flow_intra))
)
```

```{r}
gam_work_base_degree_out = gam_base

names(gam_work_base_degree_out) = purrr::map(
  names(gam_work_base_degree_out), 
  ~paste0(.x, "-work_centrality_degree_out")
)

gam_work_base_degree_out = purrr::map(
  gam_work_base_degree_out, 
  ~update.formula(.x, ~ . + s(work_centrality_degree_out, k = 4))
)
```

```{r}
gam_work_base_strength_out = gam_base

names(gam_work_base_strength_out) = purrr::map(
  names(gam_work_base_strength_out), 
  ~paste0(.x, "-work_centrality_strength_out")
)

gam_work_base_strength_out = purrr::map(
  gam_work_base_strength_out, 
  ~update.formula(.x, ~ . + s(work_centrality_strength_out))
)
```

```{r}
gam_work_base_closeness_out = gam_base

names(gam_work_base_closeness_out) = purrr::map(
  names(gam_work_base_closeness_out), 
  ~paste0(.x, "-work_centrality_closeness_out")
)

gam_work_base_closeness_out = purrr::map(
  gam_work_base_closeness_out, 
  ~update.formula(.x, ~ . + s(work_centrality_closeness_out))
)
```

```{r}
gam_work_base_betweenness_directed = gam_base

names(gam_work_base_betweenness_directed) = purrr::map(
  names(gam_work_base_betweenness_directed), 
  ~paste0(.x, "-work_centrality_betweenness_directed")
)

gam_work_base_betweenness_directed = purrr::map(
  gam_work_base_betweenness_directed, 
  ~update.formula(.x, ~ . + s(work_centrality_betweenness_directed))
)
```

```{r}
gam_work_base_eigenvector_directed = gam_base

names(gam_work_base_eigenvector_directed) = purrr::map(
  names(gam_work_base_eigenvector_directed), 
  ~paste0(.x, "-work_centrality_eigenvector_directed")
)

gam_work_base_eigenvector_directed = purrr::map(
  gam_work_base_eigenvector_directed, 
  ~update.formula(.x, ~ . + s(work_centrality_eigenvector_directed))
)
```

```{r}
gam_work_base_pagerank_directed = gam_base

names(gam_work_base_pagerank_directed) = purrr::map(
  names(gam_work_base_pagerank_directed), 
  ~paste0(.x, "-work_centrality_pagerank_directed")
)

gam_work_base_pagerank_directed = purrr::map(
  gam_work_base_pagerank_directed, 
  ~update.formula(.x, ~ . + s(work_centrality_pagerank_directed))
)
```

```{r}
gam_work_base_mobility = c(
  gam_base, gam_work_base_intra, gam_work_base_degree_out,
  gam_work_base_strength_out, gam_work_base_closeness_out,
  gam_work_base_betweenness_directed, gam_work_base_eigenvector_directed,
  gam_work_base_pagerank_directed
)
```

```{r}
gam_work_base_mobility_df = tibble(
  predictors = names(gam_work_base_mobility), 
  formula = gam_work_base_mobility
)
```

```{r}
gam_work_base_mobility_fits = gam_work_base_mobility_df |> 
  mutate(
    gam_po_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = poisson)
    ),
    gam_nb_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = nb())
    ),
  ) |> 
  tidyr::pivot_longer(
    -c(predictors, formula),
    names_to = c("model", "family"),
    names_pattern = "(.*)_(.*)_fit",
    values_to = "fit"
  )
```

```{r}
gam_work_base_mobility_results = gam_work_base_mobility_fits |> 
  mutate(aic = purrr::map(fit, ~AIC(.x))) |> 
  tidyr::unnest(aic) |> 
  arrange(aic)

gam_work_base_mobility_results
```

```{r}
summary(gam_work_base_mobility_results$fit[[1]])
```

```{r}
check_overdispersion(gam_work_base_mobility_results$fit[[1]])
```

```{r}
plot(check_overdispersion(gam_work_base_mobility_results$fit[[1]]))
```

```{r}
check_concurvity(gam_work_base_mobility_results$fit[[1]])
```

```{r fig.height=8}
gratia::appraise(gam_work_base_mobility_results$fit[[1]])
```

```{r fig.height=8}
gratia::draw(gam_work_base_mobility_results$fit[[1]])
```

```{r}
summary(gam_work_base_mobility_results$fit[[2]])
```

```{r}
check_overdispersion(gam_work_base_mobility_results$fit[[2]])
```

```{r}
plot(check_overdispersion(gam_work_base_mobility_results$fit[[2]]))
```

```{r}
check_concurvity(gam_work_base_mobility_results$fit[[2]])
```

```{r fig.height=8}
gratia::appraise(gam_work_base_mobility_results$fit[[2]])
```

```{r fig.height=8}
gratia::draw(gam_work_base_mobility_results$fit[[2]])
```

```{r}
summary(gam_work_base_mobility_results$fit[[3]])
```

```{r}
check_overdispersion(gam_work_base_mobility_results$fit[[3]])
```

```{r}
plot(check_overdispersion(gam_work_base_mobility_results$fit[[3]]))
```

```{r}
check_concurvity(gam_work_base_mobility_results$fit[[3]])
```

```{r fig.height=8}
gratia::appraise(gam_work_base_mobility_results$fit[[3]])
```

```{r fig.height=8}
gratia::draw(gam_work_base_mobility_results$fit[[3]])
```

```{r}
summary(gam_work_base_mobility_results$fit[[6]])
```

```{r}
check_overdispersion(gam_work_base_mobility_results$fit[[6]])
```

```{r}
plot(check_overdispersion(gam_work_base_mobility_results$fit[[6]]))
```

```{r}
check_concurvity(gam_work_base_mobility_results$fit[[6]])
```

```{r fig.height=8}
gratia::appraise(gam_work_base_mobility_results$fit[[6]])
```

```{r fig.height=8}
gratia::draw(gam_work_base_mobility_results$fit[[6]], residuals = TRUE)
```

```{r}
summary(gam_work_base_mobility_results$fit[[7]])
```

```{r}
check_overdispersion(gam_work_base_mobility_results$fit[[7]])
```

```{r}
plot(check_overdispersion(gam_work_base_mobility_results$fit[[7]]))
```

```{r}
check_concurvity(gam_work_base_mobility_results$fit[[7]])
```

```{r fig.height=8}
gratia::appraise(gam_work_base_mobility_results$fit[[7]])
```

```{r fig.height=8}
gratia::draw(gam_work_base_mobility_results$fit[[7]], residuals = TRUE)
```

## Model with mobilitization variables

### Full

```{r}
# dataset |> 
#   filter(incidence > 0) |> 
#   mutate(log_incidence = log(incidence)) |> 
#   dplyr::select(-c(district, new_cases, population_permanent, incidence)) |> 
#   corrr::correlate(quiet = TRUE) |> 
#   corrr::focus(log_incidence) |> 
#   arrange(-log_incidence) |> 
#   filter(grepl("centrality|flow", term)) |> 
#   filter(grepl("full", term))
```

```{r}
dataset_std |> 
  dplyr::select(
    ubn, no2, o3, full_flow_intra, full_centrality_degree_out, 
    full_centrality_strength_out, full_centrality_closeness_out, 
    full_centrality_betweenness_directed, full_centrality_eigenvector_directed,
    full_centrality_pagerank_directed
  ) |> 
  # dplyr::select(!dplyr::matches("_log|_yj")) |>
  corrr::correlate(quiet = TRUE) |> 
  corrr::stretch(na.rm = TRUE, remove.dups = TRUE) |> 
  arrange(-r)
```

```{r}
# dataset_trans |> 
#   dplyr::select(dplyr::contains("full")) |> 
#   dplyr::select(dplyr::matches("flow|strength_out|eigenvector|pagerank")) |> 
#   dplyr::select(dplyr::matches("_log")) |>
#   corrr::correlate(quiet = TRUE) |> 
#   corrr::stretch(na.rm = TRUE, remove.dups = TRUE) |> 
#   arrange(r)
```

```{r}
# dataset_trans |> 
#   dplyr::select(dplyr::contains("full")) |> 
#   dplyr::select(dplyr::matches("flow|strength_out|eigenvector|pagerank")) |> 
#   dplyr::select(dplyr::matches("_yj")) |>
#   corrr::correlate(quiet = TRUE) |> 
#   corrr::stretch(na.rm = TRUE, remove.dups = TRUE) |> 
#   arrange(r)
```

```{r}
full_additive_model_formulas = list(
  "full_flow_intra" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(full_flow_intra),
  "full_centrality_degree_out" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(full_centrality_degree_out, k = 4),
  "full_centrality_strength_out" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(full_centrality_strength_out),
  "full_centrality_closeness_out" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(full_centrality_closeness_out),
  "full_centrality_betweenness_directed" =
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(full_centrality_betweenness_directed),
  "full_centrality_eigenvector_directed" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(full_centrality_eigenvector_directed),
  "full_centrality_pagerank_directed" =
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(full_centrality_pagerank_directed)
)
```

```{r}
full_additive_model_formulas_df = tibble(
  predictors = names(full_additive_model_formulas), 
  formula = full_additive_model_formulas
)
```

```{r}
full_additive_model_fits = full_additive_model_formulas_df |> 
  mutate(
    gam_po_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = poisson)
    ),
    gam_nb_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = nb())
    ),
  ) |> 
  tidyr::pivot_longer(
    -c(predictors, formula),
    names_to = c("model", "family"),
    names_pattern = "(.*)_(.*)_fit",
    values_to = "fit"
  )
```

```{r}
full_additive_models = full_additive_model_fits |> 
  mutate(aic = purrr::map(fit, ~AIC(.x))) |> 
  tidyr::unnest(aic) |> 
  arrange(aic)

full_additive_models
```

```{r}
summary(full_additive_models$fit[[1]])
```

```{r}
check_overdispersion(full_additive_models$fit[[1]])
```

```{r}
plot(check_overdispersion(full_additive_models$fit[[1]]))
```

```{r}
check_concurvity(full_additive_models$fit[[1]])
```

```{r fig.height=8}
gratia::appraise(full_additive_models$fit[[1]])
```

```{r fig.height=8}
gratia::draw(full_additive_models$fit[[1]], residuals = TRUE)
```

```{r}
summary(full_additive_models$fit[[2]])
```

```{r}
check_overdispersion(full_additive_models$fit[[2]])
```

```{r}
plot(check_overdispersion(full_additive_models$fit[[2]]))
```

```{r}
check_concurvity(full_additive_models$fit[[2]])
```

```{r fig.height=8}
gratia::appraise(full_additive_models$fit[[2]])
```

```{r fig.height=8}
gratia::draw(full_additive_models$fit[[2]])
```

```{r}
summary(full_additive_models$fit[[3]])
```

```{r}
check_overdispersion(full_additive_models$fit[[3]])
```

```{r}
plot(check_overdispersion(full_additive_models$fit[[3]]))
```

```{r}
check_concurvity(full_additive_models$fit[[3]])
```

```{r fig.height=8}
gratia::appraise(full_additive_models$fit[[3]])
```

```{r fig.height=8}
gratia::draw(full_additive_models$fit[[3]])
```

```{r}
summary(full_additive_models$fit[[4]])
```

```{r}
check_overdispersion(full_additive_models$fit[[4]])
```

```{r}
plot(check_overdispersion(full_additive_models$fit[[4]]))
```

```{r}
check_concurvity(full_additive_models$fit[[4]])
```

```{r fig.height=8}
gratia::appraise(full_additive_models$fit[[4]])
```

```{r fig.height=8}
gratia::draw(full_additive_models$fit[[4]])
```

```{r}
summary(full_additive_models$fit[[5]])
```

```{r}
check_overdispersion(full_additive_models$fit[[5]])
```

```{r}
plot(check_overdispersion(full_additive_models$fit[[5]]))
```

```{r}
check_concurvity(full_additive_models$fit[[5]])
```

```{r fig.height=8}
gratia::appraise(full_additive_models$fit[[5]])
```

```{r fig.height=8}
gratia::draw(full_additive_models$fit[[5]])
```

```{r}
summary(full_additive_models$fit[[6]])
```

```{r}
check_overdispersion(full_additive_models$fit[[6]])
```

```{r}
plot(check_overdispersion(full_additive_models$fit[[6]]))
```

```{r}
check_concurvity(full_additive_models$fit[[6]])
```

```{r fig.height=8}
gratia::appraise(full_additive_models$fit[[6]])
```

```{r fig.height=8}
gratia::draw(full_additive_models$fit[[6]])
```

### Study

```{r}
study_additive_model_formulas = list(
  "study_flow_intra" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(study_flow_intra),
  "study_centrality_degree_out" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(study_centrality_degree_out, k = 4),
  "study_centrality_strength_out" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(study_centrality_strength_out),
  "study_centrality_closeness_out" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(study_centrality_closeness_out),
  "study_centrality_betweenness_directed" =
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(study_centrality_betweenness_directed),
  "study_centrality_eigenvector_directed" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(study_centrality_eigenvector_directed),
  "study_centrality_pagerank_directed" =
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(study_centrality_pagerank_directed)
)
```

```{r}
study_additive_model_formulas_df = tibble(
  predictors = names(study_additive_model_formulas), 
  formula = study_additive_model_formulas
)
```

```{r}
study_additive_model_fits = study_additive_model_formulas_df |> 
  mutate(
    gam_po_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = poisson)
    ),
    gam_nb_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = nb())
    ),
  ) |> 
  tidyr::pivot_longer(
    -c(predictors, formula),
    names_to = c("model", "family"),
    names_pattern = "(.*)_(.*)_fit",
    values_to = "fit"
  )
```

```{r}
study_additive_models = study_additive_model_fits |> 
  mutate(aic = purrr::map(fit, ~AIC(.x))) |> 
  tidyr::unnest(aic) |> 
  arrange(aic)

study_additive_models
```

```{r}
summary(study_additive_models$fit[[1]])
```

```{r}
check_overdispersion(study_additive_models$fit[[1]])
```

```{r}
plot(check_overdispersion(study_additive_models$fit[[1]]))
```

```{r}
check_concurvity(study_additive_models$fit[[1]])
```

```{r fig.height=8}
gratia::appraise(study_additive_models$fit[[1]])
```

```{r fig.height=8}
gratia::draw(study_additive_models$fit[[1]])
```

```{r}
summary(study_additive_models$fit[[2]])
```

```{r}
check_overdispersion(study_additive_models$fit[[2]])
```

```{r}
plot(check_overdispersion(study_additive_models$fit[[2]]))
```

```{r}
check_concurvity(study_additive_models$fit[[2]])
```

```{r fig.height=8}
gratia::appraise(study_additive_models$fit[[2]])
```

```{r fig.height=8}
gratia::draw(study_additive_models$fit[[2]])
```

### Work

```{r}
work_additive_model_formulas = list(
  "work_flow_intra" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(work_flow_intra),
  "work_centrality_degree_out" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(work_centrality_degree_out, k = 4),
  "work_centrality_strength_out" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(work_centrality_strength_out),
  "work_centrality_closeness_out" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(work_centrality_closeness_out),
  "work_centrality_betweenness_directed" =
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(work_centrality_betweenness_directed),
  "work_centrality_eigenvector_directed" = 
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(work_centrality_eigenvector_directed),
  "work_centrality_pagerank_directed" =
    new_cases ~ offset(log(population_permanent)) + s(ubn) + s(pm25) +
    s(work_centrality_pagerank_directed)
)
```

```{r}
work_additive_model_formulas_df = tibble(
  predictors = names(work_additive_model_formulas), 
  formula = work_additive_model_formulas
)
```

```{r}
work_additive_model_fits = work_additive_model_formulas_df |> 
  mutate(
    gam_po_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = poisson)
    ),
    gam_nb_fit = purrr::map(
      formula, ~gam(.x, data = dataset_std, family = nb())
    ),
  ) |> 
  tidyr::pivot_longer(
    -c(predictors, formula),
    names_to = c("model", "family"),
    names_pattern = "(.*)_(.*)_fit",
    values_to = "fit"
  )
```

```{r}
work_additive_models = work_additive_model_fits |> 
  mutate(aic = purrr::map(fit, ~AIC(.x))) |> 
  tidyr::unnest(aic) |> 
  arrange(aic)

work_additive_models
```

```{r}
work_additive_models = work_additive_model_fits |> 
  mutate(aic = purrr::map(fit, ~AIC(.x))) |> 
  tidyr::unnest(aic) |> 
  arrange(aic)

work_additive_models
```

```{r}
summary(work_additive_models$fit[[1]])
```

```{r}
check_overdispersion(work_additive_models$fit[[1]])
```

```{r}
plot(check_overdispersion(work_additive_models$fit[[1]]))
```

```{r}
check_concurvity(work_additive_models$fit[[1]])
```

```{r fig.height=8}
gratia::appraise(work_additive_models$fit[[1]])
```

```{r fig.height=8}
gratia::draw(work_additive_models$fit[[1]])
```

```{r}
summary(work_additive_models$fit[[2]])
```

```{r}
check_overdispersion(work_additive_models$fit[[2]])
```

```{r}
plot(check_overdispersion(work_additive_models$fit[[2]]))
```

```{r}
check_concurvity(work_additive_models$fit[[2]])
```

```{r fig.height=8}
gratia::appraise(work_additive_models$fit[[2]])
```

```{r fig.height=8}
gratia::draw(work_additive_models$fit[[2]])
```

## Save models

```{r}
models_path = "data/processed/models/"
full_filename = "full-models.rds"
study_filename = "study-models.rds"
work_filename = "work-models.rds"
full_filepath = fs::path(models_path, full_filename)
study_filepath = fs::path(models_path, study_filename)
work_filepath = fs::path(models_path, work_filename)
saveRDS(full_additive_models, full_filepath)
saveRDS(study_additive_models, study_filepath)
saveRDS(work_additive_models, work_filepath)
```

Sacar los distritos con mayor intra, betweenness y strength

